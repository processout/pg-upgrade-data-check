# pg-upgrade-data-check

## Description

`pg-upgrade-data-check` will compare Postgres table contents of two databases (source and target) to ensure there are no differences
in data.

It will detect discrepancies like;
- Row missing in the target database table
- Extra row in the target database table
- Difference in any column value for the same id

**Note:** It's designed to work purely on tables content (it will not check indexes, etc).
**Note 2:** It will only work for tables that have numeric id that is incremented for each row.

![doc/example-execution.png](doc/example-execution.png)

## Configuration
All configuration is contained in the `data/config.yaml` file. `db_url_1` is the source table
(on which first and second stage will be executed), `db_url_2` is the database (target) we will be comparing selected
rows from `db_url_1` to. For each of the tables to test you need to configure `collect` and `compare` queries. `collect`
query is executed in first and second stage in order to identify range of id's to compare. `compare` query should return
two values: `id` and `hash`, `hash` is used to compare rows of the same `id` between two databases. Hopefully example
queries are self-explanatory.

## Usage
As `pg-upgrade-data-check` has been designed primarily for verifying effects of cloning & replication, it operates in three stages.
You can select stage from an interactive menu after launching the application:

![doc/example-stages.png](doc/example-stages.png)

### Stage 1
For each configured table find the starting id. This query is executed on the source database, and output is
saved to `data/before_ids.json` file. For safety reasons it is not possible to execute this step if the destination
file already exist. Delete that file first if you don't care about previous result.

When using `pg-upgrade-data-check` during Postgres upgrade this stage should be executed ***before you create a replication
slot on the source database***.

### Stage 2
For each configured table find the ending id. Again, this is executed on the source database, with output written
this time to `data/after_ids.json` file. It has the same safety mechanism as previous stage.

When using `pg-upgrade-data-check` during Postgres upgrade this stage should be executed ***after target database has been restored
from snapshot and logical replication caught up to source***.

### Stage 3
Load the contents of `after_ids.json` (generated by the previous stages) and for all tables from configuration compare
rows between `startId` and `stopId`, detecting additionally any missing or extra rows on the target db.

